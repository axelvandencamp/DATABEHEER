--SET VARIABLES
DROP TABLE IF EXISTS _AV_myvar;
CREATE TEMP TABLE _AV_myvar 
	(startdatum DATE, einddatum DATE
	 ,afdeling NUMERIC, postcode TEXT, herkomst_lidmaatschap NUMERIC, wervende_organisatie NUMERIC, test_id NUMERIC
	 );

INSERT INTO _AV_myvar VALUES('2020-03-01',	--startdatum
				'2021-12-31'	--einddatum
				);
SELECT * FROM _AV_myvar;
--==============================================================
SELECT p.id, u.login, p.create_date::date, p.membership_start,
	sq1.*,
	SQ2.*
FROM _AV_myvar v, res_partner p
	JOIN (SELECT * FROM _CRM_partnerinfo()) SQ1 ON SQ1.partner_id = p.id
	--Voor de ontdubbeling veroorzaakt door meedere lidmaatschapslijnen
	LEFT OUTER JOIN (SELECT MAX(ml.id) ml_id, partner FROM _av_myvar v, membership_membership_line ml JOIN product_product pp ON pp.id = ml.membership_id WHERE pp.membership_product GROUP BY partner) ml ON ml.partner = p.id
	--factuur info
	LEFT OUTER JOIN (SELECT * FROM _crm_leden_factuurinfo()) SQ2 ON SQ2.id = ml.ml_id
	--user infor
	JOIN res_users u ON u.id = p.create_uid
	
WHERE p.active AND p.membership_state = 'none'
	AND p.create_date::date BETWEEN v.startdatum AND v.einddatum
